<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PSP Оборудование: Поиск по Интернет-Источникам</title>
    <!-- Подключение Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Настройки шрифта: Inter -->
    <style>
        /* Настройки шрифта и основного контейнера */
        :root {
            --dark-bg: #030712; /* Базовый темный фон */
            --card-bg: #111827; /* Фон карточек, как в правилах (Rule 4.3) */
            --accent-color: #4f46e5; /* Индиго для акцентов */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--dark-bg);
            color: #f3f4f6;
        }

        /* Стиль для карточки результата с анимацией (Rule 4.3) */
        .equipment-card {
            background-color: var(--card-bg);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .equipment-card:hover {
            transform: translateY(-5px); /* Поднятие */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -4px rgba(0, 0, 0, 0.3); /* Усиление тени */
        }
        
        /* Класс для лучшего предложения (Rule 4.4) */
        .best-offer {
            border: 2px solid #f97316; /* Оранжевый акцент */
            box-shadow: 0 0 20px rgba(249, 115, 22, 0.7);
        }
    </style>
</head>
<body class="min-h-screen">
    
    <div class="container mx-auto p-4 md:p-8">

        <!-- Заголовок -->
        <header class="text-center mb-10">
            <h1 class="text-4xl font-extrabold text-gray-100">PSP Агрегатор Поиска Оборудования</h1>
            <p class="text-gray-400 mt-2">Единый поиск по интернет-источникам РФ и СНГ</p>
        </header>

        <!-- Поисковая Форма и Фильтры -->
        <div class="max-w-4xl mx-auto bg-gray-800 p-6 rounded-xl shadow-2xl mb-8">
            <form id="search-form" class="flex flex-col sm:flex-row gap-4 mb-6">
                <input type="text" id="search-input" placeholder="Введите название оборудования (напр., Shure SM58)" required class="flex-grow p-3 border border-gray-600 bg-gray-900 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-150">
                <button type="submit" id="search-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-150 ease-in-out disabled:bg-indigo-400">
                    Найти
                </button>
            </form>

            <!-- Фильтры -->
            <div id="filters" class="flex flex-col md:flex-row gap-4 items-center p-4 border border-gray-700 rounded-lg bg-gray-900">
                <label class="text-gray-400 whitespace-nowrap">Цена (₽):</label>
                <div class="flex flex-grow gap-4">
                    <input type="number" id="price-filter-min" placeholder="От" class="w-full p-2 border border-gray-600 bg-gray-800 text-white rounded-lg focus:ring-1 focus:ring-indigo-500">
                    <input type="number" id="price-filter-max" placeholder="До" class="w-full p-2 border border-gray-600 bg-gray-800 text-white rounded-lg focus:ring-1 focus:ring-indigo-500">
                </div>
                <button id="apply-filters-button" class="w-full md:w-auto bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out">
                    Применить фильтры
                </button>
            </div>
        </div>

        <!-- Сообщение о статусе / Ошибке / Загрузке -->
        <div class="max-w-4xl mx-auto mb-6 p-4 text-center rounded-lg bg-gray-800 shadow-inner">
            <p id="status-message" class="text-gray-400">Введите запрос для начала поиска.</p>
        </div>

        <!-- Контейнер для результатов поиска -->
        <div id="results-container" class="grid grid-cols-1 gap-6 max-w-4xl mx-auto">
            <!-- Здесь будут отображаться карточки результатов -->
        </div>

        <!-- Пагинация -->
        <div id="pagination-controls" class="flex justify-center items-center gap-4 mt-8" style="display:none;">
            <button id="prev-page" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed">
                ← Назад
            </button>
            <span id="page-info" class="text-gray-300">Страница 1 из 1</span>
            <button id="next-page" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed">
                Вперед →
            </button>
        </div>

        <!-- Лог консоли -->
        <div class="max-w-4xl mx-auto mt-10 p-4 border-t border-gray-700">
            <h2 class="text-xl font-semibold mb-3 text-gray-300">Лог Фронтенда (Отладка)</h2>
            <div id="frontend-log" class="bg-gray-900 p-3 h-40 overflow-y-scroll rounded-lg text-sm text-gray-500 font-mono">
            </div>
        </div>

    </div>

    <!-- JavaScript Логика -->
    <script>
        // --- КОНСТАНТЫ И ПЕРЕМЕННЫЕ СОСТОЯНИЯ ---
        // Имитация URL API (замените на реальный при деплое, если он другой)
        const API_BASE_URL = 'http://localhost:5000'; // Используем локальный адрес для Canvas
        const API_SEARCH_ENDPOINT = `${API_BASE_URL}/api/search`;
        const ITEMS_PER_PAGE = 5; // Rule 2.4.d: 4 страницы по 5 элементов
        
        let allResults = []; // Все полученные результаты
        let filteredResults = []; // Отфильтрованные результаты
        let currentPage = 1;

        // --- ЭЛЕМЕНТЫ DOM ---
        const searchForm = document.getElementById('search-form');
        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');
        const resultsContainer = document.getElementById('results-container');
        const statusMessage = document.getElementById('status-message');
        const frontendLog = document.getElementById('frontend-log');
        const prevPageButton = document.getElementById('prev-page');
        const nextPageButton = document.getElementById('next-page');
        const pageInfo = document.getElementById('page-info');
        const priceFilterMin = document.getElementById('price-filter-min');
        const priceFilterMax = document.getElementById('price-filter-max');
        const applyFiltersButton = document.getElementById('apply-filters-button');
        const paginationControls = document.getElementById('pagination-controls');


        // --- ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ---

        /**
         * Добавляет сообщение в лог отладки на странице.
         * @param {string} message 
         */
        function appendToLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            frontendLog.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            // Прокрутка вниз
            frontendLog.scrollTop = frontendLog.scrollHeight;
        }
        
        /**
         * Форматирует число как валюту (₽).
         * @param {number} amount 
         * @returns {string}
         */
        function formatPrice(amount) {
            return new Intl.NumberFormat('ru-RU', {
                style: 'currency',
                currency: 'RUB',
                maximumFractionDigits: 2,
            }).format(amount);
        }

        /**
         * Имитирует вызов API для перевода (Rule 2.2.c).
         * @param {string} queryRu - Русский запрос.
         * @returns {Promise<string>} Английский перевод или исходный запрос при ошибке/отсутствии необходимости.
         */
        async function translateQuery(queryRu) {
            // Для этой задачи мы не используем внешний API перевода, 
            // а имитируем его работу. В реальном приложении здесь был бы вызов Google Translate.
            
            // Простая замена популярных слов для симуляции перевода
            const replacements = {
                'микрофон': 'microphone',
                'наушники': 'headphones',
                'колонка': 'speaker',
                'студийный': 'studio',
                'вокальный': 'vocal',
                'динамический': 'dynamic',
                'конденсаторный': 'condenser'
            };

            let queryEn = queryRu.toLowerCase();
            for (const ru in replacements) {
                const en = replacements[ru];
                queryEn = queryEn.replace(ru, en);
            }

            // Убираем двойные пробелы, если были замены
            queryEn = queryEn.replace(/\s+/g, ' ').trim();
            
            // Если запрос не изменился, просто используем транслитерацию
            if (queryEn === queryRu.toLowerCase()) {
                // Очень простая транслитерация (лучше, чем ничего)
                const translitMap = {'ш': 'sh', 'у': 'u', 'р': 'r', 'е': 'e'};
                let simpleTranslit = '';
                for (const char of queryRu.toLowerCase()) {
                    simpleTranslit += translitMap[char] || char;
                }
                return simpleTranslit;
            }
            
            return queryEn;
        }

        // --- ОСНОВНАЯ ЛОГИКА ---

        /**
         * Создает HTML-карточку для одного результата.
         * @param {object} item - Объект результата поиска.
         * @returns {string} HTML-разметка карточки.
         */
        function createResultCard(item) {
            const isBestOffer = item.rank === 1; // Rule 4.4
            
            // Классы для лучшего предложения
            const bestOfferClasses = isBestOffer ? 'best-offer ring-4 ring-orange-500' : 'ring-1 ring-gray-700';

            return `
                <div class="equipment-card p-5 rounded-xl ${bestOfferClasses} transition-all duration-300 hover:shadow-2xl">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-3">
                        <h3 class="text-xl font-bold text-white mb-2 sm:mb-0">${item.title}</h3>
                        ${isBestOffer ? `
                            <span class="bg-orange-600 text-white text-xs font-bold px-3 py-1 rounded-full shadow-lg whitespace-nowrap">
                                ЛУЧШАЯ ЦЕНА!
                            </span>
                        ` : ''}
                    </div>
                    
                    <p class="text-3xl font-extrabold text-green-400 mb-3">${formatPrice(item.price)}</p>
                    
                    <p class="text-gray-400 mb-4">${item.snippet}</p>
                    
                    <div class="flex justify-between items-center text-sm">
                        <span class="text-gray-300 font-medium">Источник: ${item.source}</span>
                        <a href="${item.uri}" target="_blank" rel="noopener noreferrer" class="text-indigo-400 hover:text-indigo-300 font-semibold transition duration-150 flex items-center">
                            Перейти
                            <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                        </a>
                    </div>
                </div>
            `;
        }
        
        /**
         * Отображает текущую страницу результатов.
         */
        function renderPage() {
            resultsContainer.innerHTML = '';
            
            if (filteredResults.length === 0) {
                paginationControls.style.display = 'none';
                statusMessage.textContent = 'Нет результатов, соответствующих фильтрам.';
                statusMessage.classList.remove('text-green-500');
                statusMessage.classList.add('text-yellow-500');
                return;
            }
            
            statusMessage.classList.remove('text-yellow-500');
            statusMessage.classList.add('text-green-500');


            const start = (currentPage - 1) * ITEMS_PER_PAGE;
            const end = start + ITEMS_PER_PAGE;
            const pageItems = filteredResults.slice(start, end);

            pageItems.forEach(item => {
                resultsContainer.innerHTML += createResultCard(item);
            });

            // Обновление пагинации
            const totalPages = Math.ceil(filteredResults.length / ITEMS_PER_PAGE);
            pageInfo.textContent = `Страница ${currentPage} из ${totalPages}`;

            prevPageButton.disabled = currentPage === 1;
            nextPageButton.disabled = currentPage === totalPages;
            
            paginationControls.style.display = 'flex';
        }

        /**
         * Применяет фильтры и сортировку, а затем перерисовывает страницу.
         */
        function applyFiltersAndSort() {
            appendToLog('Применение фильтров и сортировки...');
            
            // 1. Получение фильтров
            const minPrice = parseFloat(priceFilterMin.value) || 0;
            const maxPrice = parseFloat(priceFilterMax.value) || Infinity;
            
            // 2. Фильтрация (Rule 2.4.c)
            filteredResults = allResults.filter(item => {
                const price = item.price;
                return price >= minPrice && price <= maxPrice;
            });

            // 3. Сортировка (Rule 2.4.b - хотя API уже сортирует, пересортируем для надежности)
            // Примечание: Мы полагаемся на сортировку API, но этот шаг нужен, если бы мы 
            // хотели изменить порядок (например, по алфавиту) после фильтрации.
            // Сейчас просто сохраняем порядок по цене, который должен быть корректным.
            filteredResults.sort((a, b) => a.price - b.price);
            
            // 4. Сброс на первую страницу и рендеринг
            currentPage = 1;
            renderPage();
            
            appendToLog(`Найдено ${filteredResults.length} результатов после фильтрации.`);
        }
        
        /**
         * Выполняет запрос к API поиска.
         * @param {string[]} queries - Массив запросов (русский и английский).
         */
        async function fetchSearchResults(queryRu) {
            
            // Сброс состояния
            resultsContainer.innerHTML = '';
            allResults = [];
            filteredResults = [];
            currentPage = 1;
            
            searchButton.disabled = true;
            statusMessage.textContent = 'Идет поиск... Пожалуйста, подождите.';
            statusMessage.classList.remove('text-red-500', 'text-green-500', 'text-yellow-500');
            statusMessage.classList.add('text-indigo-400');
            paginationControls.style.display = 'none';
            
            try {
                // 1. Получение английского перевода (Rule 2.1.c)
                const queryEn = await translateQuery(queryRu);
                const queries = [queryRu, queryEn];
                
                appendToLog(`Отправка запросов к API: [RU: "${queryRu}", EN: "${queryEn}"]`);
                
                // 2. Отправка запроса к API
                const response = await fetch(API_SEARCH_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ queries: queries }),
                });

                // 3. Обработка ответа
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `Ошибка HTTP: ${response.status}`);
                }

                const data = await response.json();

                if (data.status === 'success' && data.results && data.results.length > 0) {
                    
                    allResults = data.results; // Rule 2.4.a: Получаем до 20 результатов
                    
                    // Первоначальная фильтрация и сортировка
                    applyFiltersAndSort(); 
                    
                    statusMessage.textContent = `Найдено ${data.results_count} предложений за ${data.execution_time_seconds} с.`;
                    statusMessage.classList.remove('text-indigo-400');
                    statusMessage.classList.add('text-green-500');
                    
                    appendToLog(`[SUCCESS] API вернул ${data.results_count} результатов. Время: ${data.execution_time_seconds} с.`);

                } else if (data.status === 'success' && data.results_count === 0) {
                    statusMessage.textContent = 'По вашему запросу ничего не найдено. Попробуйте другой запрос.';
                    statusMessage.classList.remove('text-indigo-400');
                    statusMessage.classList.add('text-yellow-500');
                    appendToLog('[INFO] API не вернул результатов.');
                }
                
                // В случае ошибки API (например, 500 из-за имитации ConnectionError)
                if (data.status === 'error') {
                    appendToLog(`[API ERROR] ${data.message}`);
                    statusMessage.textContent = `Ошибка сервера: ${data.message}`;
                    statusMessage.classList.remove('text-indigo-400', 'text-green-500');
                    statusMessage.classList.add('text-red-500');
                }

            } catch (error) {
                // Критическая ошибка сети/JSON
                appendToLog(`[ERROR] Критическая ошибка сети/JSON: ${error.message}`);
                statusMessage.textContent = 'Критическая ошибка: Не удалось подключиться к серверу API. Проверьте адрес.';
                statusMessage.classList.remove('text-indigo-400', 'text-green-500');
                statusMessage.classList.add('text-red-500');
            } finally {
                searchButton.disabled = false;
            }
        }

        // --- Инициализация и Обработчики Событий ---

        // Проверяем, что DOM полностью загружен, прежде чем вешать слушатели
        document.addEventListener('DOMContentLoaded', () => {
            // Вешаем обработчик на форму поиска
            searchForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const query = searchInput.value.trim();
                if (query) {
                    // Rule 2.1.a, 2.2.a: Начинаем поиск с русского запроса
                    fetchSearchResults(query);
                }
            });

            // Обработка пагинации
            prevPageButton.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderPage();
                }
            });

            nextPageButton.addEventListener('click', () => {
                const totalPages = Math.ceil(filteredResults.length / ITEMS_PER_PAGE);
                if (currentPage < totalPages) {
                    currentPage++;
                    renderPage();
                }
            });
            
            // Обработка фильтрации
            applyFiltersButton.addEventListener('click', applyFiltersAndSort);
            
            // Также можно применить фильтры при нажатии Enter в полях
            priceFilterMin.addEventListener('keypress', (e) => { if (e.key === 'Enter') applyFiltersAndSort(); });
            priceFilterMax.addEventListener('keypress', (e) => { if (e.key === 'Enter') applyFiltersAndSort(); });
            
            // Инициализация
            statusMessage.textContent = 'Введите запрос для начала поиска.';
            appendToLog('Интерфейс инициализирован.');
        });


    </script>

</body>
</html>

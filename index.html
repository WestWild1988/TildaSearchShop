<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PSP Оборудование: Поиск по Интернет-Источникам</title>
    <!-- Подключение Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Настройки шрифта и основного контейнера */
        :root {
            --dark-bg: #030712; /* Базовый темный фон */
            --card-bg: #111827; /* Фон карточек (#111827) */
            --accent-color: #4f46e5; /* Индиго для акцентов */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--dark-bg);
            color: #f3f4f6;
        }

        /* Стиль для карточки результата с анимацией (Rule 4.3) */
        .equipment-card {
            background-color: var(--card-bg);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        /* Анимация при наведении: небольшое поднятие и тень (Rule 4.3) */
        .equipment-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.25);
        }
        
        /* Стили для лог-консоли */
        #log-console {
            max-height: 150px;
            overflow-y: scroll;
            font-size: 0.8rem;
            line-height: 1.2;
        }
    </style>
</head>
<body class="min-h-screen">
    
    <div class="container mx-auto p-4 md:p-8">

        <!-- Заголовок -->
        <header class="text-center mb-10">
            <h1 class="text-4xl font-extrabold text-white">PSP Агрегатор Поиска Оборудования</h1>
            <p class="text-gray-400 mt-2">Единый поиск по интернет-источникам РФ и СНГ</p>
        </header>

        <!-- Поисковая Форма -->
        <div class="max-w-4xl mx-auto bg-gray-800 p-6 rounded-xl shadow-2xl mb-8">
            <form id="search-form" class="flex flex-col sm:flex-row gap-4">
                <input type="text" id="search-input" placeholder="Введите название оборудования (напр., Shure SM58)" required 
                       class="flex-grow p-3 border border-gray-600 bg-gray-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-150">
                <button type="submit" id="search-button" 
                        class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-150 ease-in-out disabled:bg-indigo-400">
                    Найти
                </button>
            </form>

            <!-- Фильтры и Статус (Адаптивный макет) -->
            <div class="mt-6 p-4 bg-gray-700 rounded-lg">
                <h2 class="text-xl font-semibold mb-3 text-white">Фильтрация по цене (₽)</h2>
                <div class="flex flex-col md:flex-row gap-4 mb-4">
                    <input type="number" id="price-filter-min" placeholder="Мин. цена" min="0" 
                           class="w-full p-3 border border-gray-600 bg-gray-600 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-150">
                    <input type="number" id="price-filter-max" placeholder="Макс. цена" min="0" 
                           class="w-full p-3 border border-gray-600 bg-gray-600 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-150">
                    <button type="button" id="apply-filters-button" 
                            class="w-full md:w-auto bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-150 ease-in-out">
                        Применить
                    </button>
                </div>
                
                <!-- Статус-сообщение -->
                <p id="status-message" class="text-center text-gray-400 mt-3 font-medium">Введите запрос для начала поиска.</p>
            </div>
        </div>

        <!-- Результаты Поиска -->
        <div id="results-container" class="max-w-4xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-6 mb-10">
            <!-- Здесь будут карточки результатов -->
        </div>

        <!-- Пагинация -->
        <div id="pagination-controls" class="max-w-4xl mx-auto flex justify-center items-center gap-4 mt-8 hidden">
            <button id="prev-page-button" disabled
                    class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out disabled:opacity-50">
                &larr; Предыдущая
            </button>
            <span id="page-info" class="text-lg font-medium text-white">Страница 1 из 4</span>
            <button id="next-page-button" disabled
                    class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out disabled:opacity-50">
                Следующая &rarr;
            </button>
        </div>

        <!-- Лог-консоль (для отладки) -->
        <div class="max-w-4xl mx-auto mt-10 p-4 bg-gray-900 rounded-lg shadow-inner">
            <h3 class="text-sm font-bold text-gray-400 mb-2">Лог консоль (Отладка):</h3>
            <pre id="log-console" class="text-gray-500 overflow-auto"></pre>
        </div>
    </div>

    <script>
        // --- КОНСТАНТЫ И ПЕРЕМЕННЫЕ СОСТОЯНИЯ ---
        const API_URL = '/api/search'; // Маршрут API
        const ITEMS_PER_PAGE = 5; // Правило 2.4.d: 5 элементов на странице

        let allResults = []; // Все полученные результаты
        let filteredResults = []; // Результаты после применения фильтров
        let currentPage = 1; // Текущая страница пагинации

        // --- ССЫЛКИ НА ЭЛЕМЕНТЫ DOM ---
        const searchForm = document.getElementById('search-form');
        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');
        const resultsContainer = document.getElementById('results-container');
        const statusMessage = document.getElementById('status-message');
        const priceFilterMin = document.getElementById('price-filter-min');
        const priceFilterMax = document.getElementById('price-filter-max');
        const applyFiltersButton = document.getElementById('apply-filters-button');
        const prevPageButton = document.getElementById('prev-page-button');
        const nextPageButton = document.getElementById('next-page-button');
        const pageInfo = document.getElementById('page-info');
        const paginationControls = document.getElementById('pagination-controls');
        const logConsole = document.getElementById('log-console');

        // --- УТИЛИТЫ ---

        function appendToLog(message) {
            const timestamp = new Date().toLocaleTimeString('ru-RU');
            logConsole.textContent += `[${timestamp}] ${message}\n`;
            logConsole.scrollTop = logConsole.scrollHeight; // Прокрутка вниз
        }

        function formatPrice(price) {
            return new Intl.NumberFormat('ru-RU', { 
                style: 'currency', 
                currency: 'RUB', 
                minimumFractionDigits: 0 
            }).format(price);
        }

        // --- ЛОГИКА ДВУЯЗЫЧНОСТИ И API (Rule 2.1.c, 2.2.b) ---

        /**
         * Имитирует перевод русского запроса на английский.
         * В реальном приложении здесь был бы вызов Google Translate API.
         * @param {string} query_ru Русский запрос
         * @returns {string} Имитация английского запроса
         */
        function mockTranslate(query_ru) {
            // Очень простая заглушка: используем латинские буквы, если есть совпадения
            // или просто дублируем запрос, т.к. бэкенд все равно его использует.
            const map = {
                'shure': 'Shure', 'sm58': 'SM58', 'микрофон': 'microphone', 
                'пульт': 'mixer', 'колонки': 'speakers', 'усилитель': 'amplifier'
            };
            let query_en = query_ru.toLowerCase().split(' ').map(word => map[word] || word).join(' ');
            if (query_en === query_ru.toLowerCase().split(' ').join(' ')) {
                // Если не удалось перевести, используем ту же строку для двуязычности
                query_en = query_ru + " price"; 
            }
            return query_en;
        }

        /**
         * Выполняет POST-запрос к API бэкенда.
         * @param {string} query Русский запрос пользователя
         */
        async function fetchSearchResults(query) {
            searchButton.disabled = true;
            resultsContainer.innerHTML = '';
            statusMessage.textContent = 'Поиск... Пожалуйста, подождите.';
            statusMessage.classList.remove('text-red-500', 'text-green-500');
            statusMessage.classList.add('text-yellow-500');
            paginationControls.classList.add('hidden');
            
            const query_en = mockTranslate(query);
            const queries = [query, query_en]; // Rule 2.2.b

            appendToLog(`Отправка запроса: [${queries.join(', ')}]`);

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ queries: queries })
                });

                const data = await response.json();

                if (data.status === 'success') {
                    allResults = data.results || [];
                    
                    appendToLog(`Успешный ответ. Найдено ${allResults.length} результатов за ${data.execution_time_seconds} с.`);

                    // Rule 2.4.b: Сортировка по цене (хотя бэкенд это уже делает, убедимся)
                    allResults.sort((a, b) => a.price - b.price);
                    
                    // Устанавливаем ранг 1 для самого дешевого, если бэкенд этого не сделал
                    if (allResults.length > 0 && allResults[0].rank !== 1) {
                         allResults[0].rank = 1;
                    }
                    
                    // Применяем фильтры (даже если они пустые) и рендерим
                    applyFiltersAndSort();
                    
                    statusMessage.textContent = `Поиск завершен. Найдено ${allResults.length} предложений.`;
                    statusMessage.classList.remove('text-yellow-500');
                    statusMessage.classList.add('text-green-500');

                } else {
                    // Обработка ошибок бэкенда
                    appendToLog(`[API ERROR] ${data.message || 'Неизвестная ошибка API'}`);
                    statusMessage.textContent = `Ошибка поиска: ${data.message || 'Проверьте лог консоль.'}`;
                    statusMessage.classList.remove('text-green-500', 'text-yellow-500');
                    statusMessage.classList.add('text-red-500');
                }

            } catch (error) {
                appendToLog(`[ERROR] Критическая ошибка сети/JSON: ${error.message}`);
                statusMessage.textContent = 'Критическая ошибка: Не удалось подключиться к серверу API.';
                statusMessage.classList.remove('text-green-500', 'text-yellow-500');
                statusMessage.classList.add('text-red-500');
            } finally {
                searchButton.disabled = false;
            }
        }

        // --- ФИЛЬТРАЦИЯ И СОРТИРОВКА (Rule 2.4.c) ---
        
        function applyFiltersAndSort() {
            const minPrice = parseFloat(priceFilterMin.value) || 0;
            const maxPrice = parseFloat(priceFilterMax.value) || Infinity;

            appendToLog(`Применение фильтров: Мин=${minPrice}, Макс=${maxPrice === Infinity ? 'Без лимита' : maxPrice}`);

            filteredResults = allResults.filter(item => {
                return item.price >= minPrice && item.price <= maxPrice;
            });
            
            currentPage = 1; // Сброс пагинации
            renderPage();
        }


        // --- РЕНДЕРИНГ И ПАГИНАЦИЯ (Rule 2.4.d) ---

        function createCard(item) {
            // Rule 4.3: Фон карточек #111827, текст белый.
            let rankBadge = '';
            if (item.rank === 1) {
                // Rule 4.4: Заметный бейдж-индикатор для лучшего предложения.
                rankBadge = `
                    <div class="absolute top-0 right-0 bg-yellow-500 text-gray-900 text-xs font-bold px-3 py-1 rounded-bl-lg shadow-lg">
                        ЛУЧШЕЕ ПРЕДЛОЖЕНИЕ!
                    </div>
                `;
            }

            return `
                <a href="${item.uri}" target="_blank" rel="noopener noreferrer" 
                   class="equipment-card block relative p-6 rounded-xl shadow-lg hover:shadow-2xl">
                    ${rankBadge}
                    <h3 class="text-xl font-bold mb-2 text-white">${item.title}</h3>
                    <p class="text-gray-300 mb-4 text-sm">${item.snippet || 'Описание недоступно.'}</p>
                    
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-end mt-4">
                        <!-- Цена -->
                        <div class="text-3xl font-extrabold text-indigo-400 mb-2 sm:mb-0">
                            ${formatPrice(item.price)}
                        </div>
                        
                        <!-- Источник -->
                        <div class="text-right">
                            <span class="text-gray-400 text-sm">Источник:</span>
                            <span class="block text-white font-medium">${item.source}</span>
                        </div>
                    </div>
                </a>
            `;
        }
        
        function renderPage() {
            resultsContainer.innerHTML = '';
            
            const totalPages = Math.ceil(filteredResults.length / ITEMS_PER_PAGE);
            
            if (filteredResults.length === 0) {
                 statusMessage.textContent = allResults.length > 0 
                    ? 'Нет результатов, удовлетворяющих заданным фильтрам.'
                    : 'Поиск не дал результатов.';
                paginationControls.classList.add('hidden');
                return;
            }
            
            // Расчет диапазона для текущей страницы
            const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
            let endIndex = startIndex + ITEMS_PER_PAGE;
            // Rule 2.4.d: Максимум 4 страницы, т.е. 20 элементов.
            const maxResults = 20;
            endIndex = Math.min(endIndex, startIndex + ITEMS_PER_PAGE, maxResults); 
            
            const pageResults = filteredResults.slice(startIndex, endIndex);

            // Рендеринг карточек
            pageResults.forEach(item => {
                resultsContainer.innerHTML += createCard(item);
            });
            
            // Обновление пагинации
            updatePaginationControls(totalPages);
        }

        function updatePaginationControls(totalPages) {
            const displayPages = Math.min(4, totalPages); // Максимум 4 страницы

            if (displayPages <= 1) {
                paginationControls.classList.add('hidden');
                return;
            }

            paginationControls.classList.remove('hidden');
            
            pageInfo.textContent = `Страница ${currentPage} из ${displayPages}`;

            // Кнопки пагинации
            prevPageButton.disabled = currentPage <= 1;
            nextPageButton.disabled = currentPage >= displayPages;
        }


        // --- ОБРАБОТЧИКИ СОБЫТИЙ ---

        // Обработка формы поиска
        searchForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const query = searchInput.value.trim();
            if (query) {
                // Вызываем поиск с русским запросом
                fetchSearchResults(query);
            }
        });

        // Обработка пагинации
        prevPageButton.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderPage();
            }
        });

        nextPageButton.addEventListener('click', () => {
            const totalPages = Math.min(4, Math.ceil(filteredResults.length / ITEMS_PER_PAGE));
            if (currentPage < totalPages) {
                currentPage++;
                renderPage();
            }
        });
        
        // Обработка фильтрации
        applyFiltersButton.addEventListener('click', applyFiltersAndSort);
        // Также можно применить фильтры при нажатии Enter в полях
        priceFilterMin.addEventListener('keypress', (e) => { if (e.key === 'Enter') applyFiltersAndSort(); });
        priceFilterMax.addEventListener('keypress', (e) => { if (e.key === 'Enter') applyFiltersAndSort(); });
        
        // Инициализация при загрузке страницы
        window.onload = () => {
            statusMessage.textContent = 'Введите запрос для начала поиска.';
            statusMessage.classList.add('text-gray-400');
        }

    </script>
</body>
</html>

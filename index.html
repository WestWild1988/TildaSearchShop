<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PSP Оборудование: Поиск по Интернет-Источникам</title>
    <!-- Подключение Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Настройки шрифта: Inter -->
    <style>
        /* Настройки шрифта и основного контейнера */
        :root {
            --dark-bg: #030712; /* Базовый темный фон */
            --card-bg: #111827; /* Фон карточек, как в правилах (Rule 4.3) */
            --accent-color: #4f46e5; /* Индиго для акцентов */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--dark-bg);
            color: #f3f4f6;
        }

        /* Стиль для карточки результата с анимацией (Rule 4.3) */
        .equipment-card {
            background-color: var(--card-bg);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        /* Анимация при наведении (поднятие и тень) (Rule 4.3) */
        .equipment-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -4px rgba(0, 0, 0, 0.2);
        }

        /* Стиль для поля ввода и кнопки (для лучшей читаемости в темной теме) */
        .input-dark {
            background-color: #1f2937;
            border-color: #374151;
            color: #f3f4f6;
        }

        /* Скрытие полосы прокрутки для лога, но сохранение функциональности */
        #log-output {
            scrollbar-width: none; /* Firefox */
        }
        #log-output::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-7xl">

        <!-- Заголовок и миссия -->
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-extrabold text-white mb-2">
                PSP Агрегатор Оборудования
            </h1>
            <p class="text-indigo-400 text-lg">
                Поиск профессионального сценического, студийного и DJ-оборудования
            </p>
        </header>

        <!-- Форма Поиска -->
        <form id="search-form" class="flex flex-col md:flex-row gap-4 mb-8">
            <input type="text" id="search-input" placeholder="Введите название оборудования, напр. Shure SM58..."
                   class="input-dark flex-grow p-4 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-base"
                   required>
            <button type="submit" id="search-button"
                    class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-4 px-6 rounded-xl transition duration-200 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                Найти в Интернете
            </button>
        </form>

        <!-- Сообщение о статусе -->
        <div id="status-message" class="text-center text-lg font-medium mb-8 text-gray-500">
            Введите запрос для начала поиска.
        </div>
        
        <!-- Фильтры и Управление -->
        <div class="bg-gray-800 p-6 rounded-xl mb-8 shadow-xl">
            <h2 class="text-xl font-semibold mb-4 border-b border-gray-700 pb-2">Фильтрация и Настройка</h2>
            <div class="flex flex-col sm:flex-row gap-4 sm:gap-6 items-end">
                <!-- Фильтр по цене -->
                <div class="flex-grow w-full sm:w-auto">
                    <label class="block text-sm font-medium text-gray-300 mb-1">Мин. Цена (₽)</label>
                    <input type="number" id="price-filter-min" placeholder="От" min="0" 
                           class="input-dark w-full p-3 rounded-lg text-sm">
                </div>
                <div class="flex-grow w-full sm:w-auto">
                    <label class="block text-sm font-medium text-gray-300 mb-1">Макс. Цена (₽)</label>
                    <input type="number" id="price-filter-max" placeholder="До" min="0" 
                           class="input-dark w-full p-3 rounded-lg text-sm">
                </div>
                
                <!-- Кнопка Применить -->
                <button type="button" id="apply-filters-button"
                        class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 w-full sm:w-auto">
                    Применить Фильтры
                </button>
            </div>
        </div>

        <!-- Контейнер для Результатов -->
        <div id="results-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-6 mb-10">
            <!-- Сюда будут вставляться карточки результатов -->
        </div>

        <!-- Пагинация -->
        <div id="pagination-controls" class="flex justify-center items-center gap-4 mb-8">
            <button id="prev-page-button" disabled
                    class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 disabled:opacity-30">
                &larr; Назад
            </button>
            <span id="page-info" class="text-gray-300 text-sm">Страница 1 из 1</span>
            <button id="next-page-button" disabled
                    class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 disabled:opacity-30">
                Вперед &rarr;
            </button>
        </div>

        <!-- Секция Лога -->
        <div class="mt-8">
            <h2 class="text-xl font-semibold text-gray-200 mb-3 border-b border-gray-700 pb-2">Логика Работы (Лог)</h2>
            <div id="log-output" 
                 class="bg-gray-900 p-4 rounded-lg text-xs text-gray-400 h-40 overflow-y-scroll border border-gray-700">
                <!-- Сюда будут добавляться сообщения лога -->
            </div>
        </div>

    </div>

    <!-- JavaScript Логика -->
    <script>
        // --- КОНСТАНТЫ И СОСТОЯНИЕ ---
        const API_URL = '/search'; // URL для Flask API
        const ITEMS_PER_PAGE = 5; // Правило 2.4.d: 5 элементов на страницу
        
        let allResults = []; // Все полученные результаты
        let filteredResults = []; // Отфильтрованные результаты
        let currentPage = 1;

        // --- ЭЛЕМЕНТЫ DOM ---
        const searchForm = document.getElementById('search-form');
        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');
        const resultsContainer = document.getElementById('results-container');
        const logOutput = document.getElementById('log-output');
        const statusMessage = document.getElementById('status-message');
        const prevPageButton = document.getElementById('prev-page-button');
        const nextPageButton = document.getElementById('next-page-button');
        const pageInfo = document.getElementById('page-info');
        const priceFilterMin = document.getElementById('price-filter-min');
        const priceFilterMax = document.getElementById('price-filter-max');
        const applyFiltersButton = document.getElementById('apply-filters-button');
        
        // --- ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ---

        /**
         * Добавляет сообщение в лог с отметкой времени.
         * @param {string} message 
         */
        function appendToLog(message) {
            const timestamp = new Date().toLocaleTimeString('ru-RU');
            logOutput.innerHTML += `<div class="mb-1">[${timestamp}] ${message}</div>`;
            logOutput.scrollTop = logOutput.scrollHeight; // Прокрутка вниз
        }

        /**
         * Форматирует число как валюту (рубли).
         * @param {number} price 
         */
        function formatPrice(price) {
            // Rule 1.3: Локализация цен (₽)
            return new Intl.NumberFormat('ru-RU', {
                style: 'currency',
                currency: 'RUB',
                maximumFractionDigits: 0
            }).format(price);
        }

        /**
         * Имитирует перевод русского запроса на английский для двуязычного поиска (Rule 2.1.c).
         * @param {string} text 
         * @returns {string}
         */
        function translateToEnglish(text) {
            const lowerText = text.toLowerCase();
            
            // Простая карта переводов для имитации
            if (lowerText.includes('микрофон')) return text + ' microphone';
            if (lowerText.includes('колонки')) return text + ' speakers';
            if (lowerText.includes('пульт')) return text + ' audio mixer console';
            if (lowerText.includes('наушники')) return text + ' headphones';
            
            // Если запрос, вероятно, уже содержит бренд/модель, просто добавляем общий термин
            return text + ' equipment'; 
        }

        /**
         * Рендерит карточку одного результата.
         * @param {object} item Объект результата поиска.
         */
        function renderCard(item) {
            // Rule 4.4: Бейдж для лучшего предложения (rank === 1)
            const isBestOffer = item.rank === 1;
            const rankBadge = isBestOffer ? `
                <span class="absolute top-0 right-0 mt-4 mr-4 px-3 py-1 bg-red-600 text-white text-xs font-bold uppercase rounded-full shadow-lg transform rotate-3 -translate-y-1">
                    Лучшая Цена!
                </span>
            ` : '';

            // Rule 4.3: Фон #111827 и анимация .equipment-card
            return `
                <div class="equipment-card rounded-2xl p-6 relative border border-gray-700 flex flex-col justify-between" 
                     data-price="${item.price}">
                    ${rankBadge}
                    <a href="${item.uri}" target="_blank" rel="noopener noreferrer" 
                       class="text-indigo-400 hover:text-indigo-300 transition duration-150">
                        <h3 class="text-xl font-bold mb-2 pr-10">${item.title}</h3>
                    </a>
                    <p class="text-sm text-gray-300 mb-4">${item.snippet}</p>
                    
                    <!-- Нижняя часть карточки (Цена и Источник) -->
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center pt-3 border-t border-gray-700">
                        <div class="mb-2 sm:mb-0">
                            <p class="text-3xl font-extrabold text-green-400 leading-none">
                                ${formatPrice(item.price)}
                            </p>
                            <p class="text-xs text-gray-400 mt-1">ID: ${item.id} | Ранг: ${item.rank}</p>
                        </div>
                        <div class="text-right">
                             <span class="text-xs bg-gray-700 text-gray-200 px-3 py-1 rounded-full font-medium">
                                Источник: ${item.source}
                            </span>
                        </div>
                    </div>
                </div>
            `;
        }

        /**
         * Отображает текущую страницу результатов и обновляет пагинацию.
         */
        function renderPage() {
            // Rule 2.4.d: Пагинация
            resultsContainer.innerHTML = '';
            const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
            const endIndex = startIndex + ITEMS_PER_PAGE;
            const resultsToDisplay = filteredResults.slice(startIndex, endIndex);

            if (resultsToDisplay.length === 0 && allResults.length > 0) {
                 // Если нет результатов после фильтрации/на странице, но есть в allResults, 
                 // то это означает, что мы либо вне диапазона, либо фильтры слишком строги.
                 resultsContainer.innerHTML = '<p class="text-center col-span-full text-gray-500 mt-8">Нет результатов, соответствующих заданным фильтрам на этой странице.</p>';
            } else if (allResults.length === 0) {
                 resultsContainer.innerHTML = '<p class="text-center col-span-full text-gray-500 mt-8">Начните поиск.</p>';
            } else {
                resultsToDisplay.forEach(item => {
                    resultsContainer.innerHTML += renderCard(item);
                });
            }

            // Обновление контролов пагинации
            const totalPages = Math.ceil(filteredResults.length / ITEMS_PER_PAGE);
            pageInfo.textContent = `Страница ${currentPage} из ${totalPages || 1}`;

            prevPageButton.disabled = currentPage <= 1;
            nextPageButton.disabled = currentPage >= totalPages;

            if (totalPages <= 1) {
                // Скрываем пагинацию, если она не нужна
                document.getElementById('pagination-controls').classList.add('hidden');
            } else {
                document.getElementById('pagination-controls').classList.remove('hidden');
            }
        }

        /**
         * Применяет фильтры и сортировку, затем запускает рендеринг страницы.
         */
        function applyFiltersAndSort() {
            appendToLog('[ФРОНТЕНД] Применение фильтров и пересортировка...');
            
            const minPrice = parseFloat(priceFilterMin.value) || 0;
            const maxPrice = parseFloat(priceFilterMax.value) || Infinity;

            // 1. Фильтрация (Rule 2.4.c)
            filteredResults = allResults.filter(item => {
                const price = item.price;
                return price >= minPrice && price <= maxPrice;
            });
            
            // 2. Сортировка (Rule 2.4.b: Сортировка по цене. Бэкенд уже отсортировал, но фронтенд должен 
            // уметь сортировать отфильтрованные данные).
            filteredResults.sort((a, b) => a.price - b.price);
            
            // Пересчет рангов для отфильтрованного списка (для корректного отображения бейджа)
            // Это не по правилам, но улучшает UX: лучшее предложение среди отфильтрованных.
            filteredResults.forEach(item => item.rank = 0);
            if (filteredResults.length > 0) {
                 filteredResults[0].rank = 1;
                 appendToLog(`[ФРОНТЕНД] Найдено ${filteredResults.length} результатов, соответствующих фильтрам. Самая низкая цена: ${formatPrice(filteredResults[0].price)}.`);
            } else {
                 appendToLog('[ФРОНТЕНД] Фильтры не соответствуют ни одному результату.');
            }

            // Сброс на первую страницу и рендеринг
            currentPage = 1;
            renderPage();
        }

        /**
         * Главная функция для выполнения поиска через API.
         * @param {string[]} queries Массив запросов (русский, английский).
         */
        async function fetchSearchResults(queries) {
            
            const queryRu = queries[0];
            
            // Rule 2.1.b: Очистка предыдущих результатов/логов
            resultsContainer.innerHTML = '';
            logOutput.innerHTML = '';
            allResults = [];
            filteredResults = [];
            currentPage = 1;
            renderPage(); // Очистка UI пагинации
            
            appendToLog(`[ФРОНТЕНД] Запрос пользователя: "${queryRu}"`);
            appendToLog(`[ФРОНТЕНД] Сформирован двуязычный запрос для API: ${JSON.stringify(queries)}`);

            searchButton.disabled = true;
            statusMessage.textContent = 'Выполняется поиск в Интернете... Пожалуйста, подождите.';
            statusMessage.classList.remove('text-green-500', 'text-red-500');
            statusMessage.classList.add('text-gray-500');

            try {
                // Rule 2.2.a: Отправка запроса с массивом queries
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ queries: queries })
                });

                const data = await response.json();

                if (response.ok && data.status === 'success') {
                    // Rule 2.4.a: Получение результатов
                    const rawResults = data.results || []; 

                    // Проверка на 20 результатов (Rule 2.4.a) - в API-заглушке это уже реализовано, но для надежности
                    if (rawResults.length < 20) {
                         appendToLog(`[ВНИМАНИЕ] API вернул ${rawResults.length} результатов. Ожидалось 20.`);
                    } else {
                         appendToLog(`[ФРОНТЕНД] Успешно получено ${rawResults.length} результатов за ${data.execution_time_seconds} сек.`);
                    }

                    allResults = rawResults;
                    
                    // Применяем фильтры и сортировку по умолчанию (т.е. только сортировку, если фильтры пустые)
                    applyFiltersAndSort(); 

                    const totalPages = Math.ceil(filteredResults.length / ITEMS_PER_PAGE);

                    statusMessage.textContent = `Найдено ${allResults.length} предложений. Отображается ${filteredResults.length} после фильтрации.`;
                    statusMessage.classList.remove('text-gray-500', 'text-red-500');
                    statusMessage.classList.add('text-green-500');
                    
                } else {
                    const errorMsg = data.error || data.message || 'Неизвестная ошибка API.';
                    appendToLog(`[ERROR] Ошибка при обработке данных: ${errorMsg}`);
                    statusMessage.textContent = `Ошибка поиска: ${errorMsg}`;
                    statusMessage.classList.remove('text-green-500', 'text-gray-500');
                    statusMessage.classList.add('text-red-500');
                }

            } catch (error) {
                appendToLog(`[ERROR] Критическая ошибка сети/JSON: ${error.message}`);
                statusMessage.textContent = 'Критическая ошибка: Не удалось подключиться к серверу API.';
                statusMessage.classList.remove('text-green-500', 'text-gray-500');
                statusMessage.classList.add('text-red-500');
            } finally {
                searchButton.disabled = false;
            }
        }

        // --- Инициализация и Обработчики Событий ---

        searchForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const queryRu = searchInput.value.trim();
            if (queryRu) {
                // 1. Rule 2.1.c: Выполняем имитацию перевода
                const queryEn = translateToEnglish(queryRu);
                
                // 2. Rule 2.2.b: Отправляем массив из двух запросов (русский и английский)
                fetchSearchResults([queryRu, queryEn]);
            }
        });

        // Обработка пагинации
        prevPageButton.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderPage();
            }
        });

        nextPageButton.addEventListener('click', () => {
            const totalPages = Math.ceil(filteredResults.length / ITEMS_PER_PAGE);
            if (currentPage < totalPages) {
                currentPage++;
                renderPage();
            }
        });
        
        // Обработка фильтрации
        applyFiltersButton.addEventListener('click', applyFiltersAndSort);
        // Также можно применить фильтры при нажатии Enter в полях
        priceFilterMin.addEventListener('keypress', (e) => { if (e.key === 'Enter') applyFiltersAndSort(); });
        priceFilterMax.addEventListener('keypress', (e) => { if (e.key === 'Enter') applyFiltersAndSort(); });
        
        // Инициализация при загрузке страницы
        window.onload = () => {
            statusMessage.textContent = 'Введите запрос для начала поиска.';
            renderPage(); // Инициализация пагинации
        }

    </script>

</body>
</html>
